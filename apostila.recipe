# -*- coding: utf-8 -*-
from urllib.parse import urljoin
from calibre.web.feeds.news import BasicNewsRecipe

class ApostilaMWB(BasicNewsRecipe):
    """
    Receita para baixar a "Apostila de Reunião Vida e Ministério" (MWB) completa
    do jw.org.
    """

    # --- METADADOS DO E-BOOK ---
    title          = 'Apostila da Reunião (MWB)'
    language       = 'pt-BR'
    encoding       = 'utf-8'
    description    = 'Apostila de Reunião Vida e Ministério Cristão completa, extraida do jw.org.'

    # --- CONFIGURACAO DE REDE ---
    # [cite: timeout = 120.0]
    timeout = 600
    # [cite: delay = 0]
    delay = 1

    # --- CONFIGURACAO DE EXTRACAO ---
    # [cite: index_url = 'https://www.jw.org/pt/biblioteca/jw-apostila-do-mes/novembro-dezembro-2025-mwb/']
    index_url = 'https://www.jw.org/pt/biblioteca/jw-apostila-do-mes/novembro-dezembro-2025-mwb/'

    # [cite: recursions = 0]
    recursions = 1 

    # [cite: keep_only_tags = []]
    keep_only_tags = [
        dict(id='article')
    ]

    # --- CONFIGURACOES ADICIONAIS DE LIMPEZA ---
    no_stylesheets = True
    remove_javascript = True

    # [cite: def get_browser(self, *args, **kwargs):]
    def get_browser(self, *args, **kwargs):
        br = super().get_browser(*args, **kwargs)
        br.addheaders = [
            ('User-Agent', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36'),
            ('Accept', 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'),
            ('Accept-Language', 'pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7')
        ]
        return br
    
    # --- METODO DE EXTRACAO (Nivel 1 -> Nivel 2) ---
    # [cite: def parse_index(self):]
    def parse_index(self):
        
        self.log(f"Baixando indice de: {self.index_url}")
        
        try:
            soup = self.index_to_soup(self.index_url)
        except Exception as e:
            self.log.error(f"Falha ao baixar o indice principal: {e}")
            return [] 

        main_content = soup.find('article', attrs={'id': 'article'})

        if not main_content:
            self.log.error("Nao foi possivel encontrar <article id='article'> na pagina de indice.")
            return []

        articles = []
        links = main_content.find_all('a')
        self.log(f"Encontrados {len(links)} links no indice principal.")

        for link in links:
            # [cite: classmethod tag_to_string(tag, ...)]
            title = self.tag_to_string(link) 
            href = link.get('href')

            if not href or not title or href.startswith('#') or not title.strip():
                continue
                
            url = urljoin(self.index_url, href)

            articles.append({
                'title': title.strip(),
                'url': url
            })

        self.log(f"Processados {len(articles)} artigos (capitulos) validos.")
        
        # [cite: parse_index()]
        return [('Apostila da Reunião', articles)]
